<!DOCTYPE html>
<html lang="en">
<head>
    <title>Secure Cloud Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Login Screen Styles */
        #auth-screen { background: #111; position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .auth-box { background: #222; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #000; color: white; }
        button { width: 100%; padding: 12px; background: #1DA1F2; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Chat Styles */
        #chat-screen { display: none; flex-direction: column; height: 100vh; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 12px; padding: 10px; border-radius: 10px; background: #222; max-width: 80%; align-self: flex-start; }
        .my-msg { align-self: flex-end; background: #1DA1F2; }
        .badge { margin-left: 5px; font-size: 14px; }
        
        .input-area { padding: 15px; background: #111; display: flex; gap: 10px; }
        #m-input { flex: 1; background: #222; border: none; padding: 10px; color: white; border-radius: 20px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2>Welcome</h2>
            <input id="username" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button onclick="login()">Enter Chat</button>
        </div>
    </div>

    <div id="chat-screen">
        <div id="messages"></div>
        <div class="input-area">
            <input id="m-input" placeholder="Type a message..." autocomplete="off">
            <button onclick="sendMsg()" style="width: auto; padding: 10px 20px;">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "";

        // 1. LOGIN LOGIC
        function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if(user && pass) {
                socket.emit('authenticate', { username: user, password: pass });
            }
        }

        socket.on('auth-success', (username) => {
            myName = username;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            // Join a global room or private room. For now, let's use global.
            socket.emit('join-private', { me: myName, other: 'Global' }); 
        });

        socket.on('error-msg', (msg) => alert(msg));

        // 2. MESSAGE LOGIC
        function sendMsg() {
            const txt = document.getElementById('m-input').value;
            if(txt) {
                socket.emit('send-private-msg', {
                    sender: myName,
                    receiver: 'Global',
                    text: txt
                });
                document.getElementById('m-input').value = "";
            }
        }

        socket.on('new-msg', (data) => {
            displayMsg(data);
        });

        socket.on('load-history', (history) => {
            document.getElementById('messages').innerHTML = "";
            history.forEach(displayMsg);
        });

        function displayMsg(data) {
            const div = document.createElement('div');
            const isMe = data.sender === myName;
            div.className = `msg ${isMe ? 'my-msg' : ''}`;
            
            // Show the Badge (like the checkmark from Admin)
            const badgeHtml = data.badge ? `<span class="badge">${data.badge}</span>` : "";

            div.innerHTML = `
                <div style="font-size: 12px; opacity: 0.7;">${data.sender}${badgeHtml}</div>
                <div>${data.text}</div>
                <div style="font-size: 10px; text-align: right; margin-top: 5px;">${data.time}</div>
            `;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 99999;
        }
    </script>
</body>
</html>
